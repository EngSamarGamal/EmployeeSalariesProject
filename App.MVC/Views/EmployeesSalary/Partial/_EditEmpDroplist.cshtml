<script>
    document.addEventListener("DOMContentLoaded", function () {
      // API endpoint (user-provided)
      const apiUrl = "http://localhost:7037/api/Employee/GetAllEmp";

      // element references
      const employeeSelect = document.getElementById('employeeSelect');
      const jobField = document.getElementById('jobField');
      const basicSalaryField = document.getElementById('basicSalary');

      // Helper - escape HTML to avoid injection when building option strings
      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      if (!employeeSelect) {
        console.error("employeeSelect element not found.");
        return;
      }

      async function loadEmployees() {
        employeeSelect.innerHTML = `<option value="">جاري التحميل...</option>`;
        try {
          const res = await fetch(apiUrl, { credentials: 'include' }); // keep credentials if auth via cookies
          if (!res.ok) {
            console.error("Failed to fetch employees:", res.status, res.statusText);
            employeeSelect.innerHTML = `<option value="">فشل تحميل الموظفين (${res.status})</option>`;
            return;
          }

          const json = await res.json();
          // adjust to API shape: try common shapes
          const list = json.result ?? json.data ?? json;
          if (!Array.isArray(list) || list.length === 0) {
            employeeSelect.innerHTML = `<option value="">لا يوجد موظفين</option>`;
            return;
          }

          // read server-selected id passed via data-selected attribute (from Razor Model)
          const serverSelected = (employeeSelect.dataset && employeeSelect.dataset.selected) ? employeeSelect.dataset.selected.trim() : "";

          // normalize to string for matching
          const selectedNormalized = serverSelected ? serverSelected.replace(/[{}]/g, "").toLowerCase() : "";

          // convert to array of normalized objects
          const mapped = list.map(emp => {
            const id = (emp.employeeId ?? emp.EmployeeId ?? emp.id ?? "").toString();
            return {
              raw: emp,
              id: id,
              idNormalized: id.replace(/[{}]/g, "").toLowerCase(),
              name: (emp.fullName ?? emp.FullName ?? emp.name ?? "—").toString(),
              job: (emp.job ?? emp.Job ?? "").toString(),
              base: (emp.baseSalary ?? emp.BaseSalary ?? emp.baseSalary ?? "").toString()
            };
          });

          // If server-selected found, move that employee to the front of the array
          if (selectedNormalized) {
            const idx = mapped.findIndex(x => x.idNormalized === selectedNormalized);
            if (idx > 0) {
              const [selItem] = mapped.splice(idx, 1);
              mapped.unshift(selItem);
            } else if (idx === -1) {
              // not found — optionally keep list as-is, but we log a warning
              console.warn("Selected employee id from server not found in API list:", serverSelected);
            }
          }

          // Build options: ensure the first option is the selected employee (if any)
          const options = [];
          options.push(`<option value="">اختر الموظف</option>`);
          mapped.forEach((m, index) => {
            // mark the first mapped item as selected if it matches serverSelected, or if serverSelected was not provided, no selection
            let selectedAttr = "";
            if (selectedNormalized && index === 0 && mapped[0].idNormalized === selectedNormalized) {
              selectedAttr = ' selected';
            } else if (!selectedNormalized && false) {
              // no default selection if server hasn't provided one
            }
            options.push(`<option value="${escapeHtml(m.id)}" data-job="${escapeHtml(m.job)}" data-basesalary="${escapeHtml(m.base)}"${selectedAttr}>${escapeHtml(m.name)}</option>`);
          });

          employeeSelect.innerHTML = options.join("");

          // After building, if serverSelected was provided, ensure it's selected (safety)
          if (selectedNormalized) {
            // Try direct assignment first
            employeeSelect.value = serverSelected;
            if (employeeSelect.value !== serverSelected) {
              // fallback: find by normalized match
              for (let i = 0; i < employeeSelect.options.length; i++) {
                const optVal = (employeeSelect.options[i].value || "").replace(/[{}]/g, "").toLowerCase();
                if (optVal === selectedNormalized) {
                  employeeSelect.selectedIndex = i;
                  break;
                }
              }
            }
          }

          // Trigger change to populate job & base salary fields
          employeeSelect.dispatchEvent(new Event('change', { bubbles: true }));

        } catch (err) {
          console.error("Error loading employees:", err);
          employeeSelect.innerHTML = `<option value="">فشل تحميل الموظفين</option>`;
        }
      }

      // fill job & basic fields when selection changes
      employeeSelect.addEventListener('change', function () {
        const opt = employeeSelect.options[employeeSelect.selectedIndex];
        const job = opt?.dataset?.job ?? "";
        const base = opt?.dataset?.basesalary ?? "";
        if (jobField) jobField.value = job;
        if (basicSalaryField) basicSalaryField.value = base;
      });

      // run loader
      loadEmployees();
    });
</script>